@model MahjongAccount.Models.ViewModels.IndexViewModel
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>麻将记账 - 首页</title>
    <link href="~/lib/weui.min.css" rel="stylesheet" />
    <link href="~/css/jquery-weui.min.css" rel="stylesheet" />
    <link href="~/css/font-awesome.min.css" rel="stylesheet" />
    <script src="~/lib/jquery-2.1.4.js"></script>
    <script src="~/js/jquery-weui.js"></script>
    <style>
        .user-info {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: #fff;
            border-bottom: 1px solid #eee;
            justify-content: space-between; /* 新增：两端对齐 */
        }

        .user-main {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .user-nickname {
            font-size: 18px;
            font-weight: 500;
        }

        .user-stats {
            margin-top: 8px;
            font-size: 14px;
            color: #666;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .user-action-btn {
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 14px;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .edit-profile {
            background-color: #e8f5e9;
            color: #1AAD19;
        }

            .edit-profile:active {
                background-color: #dcedc8;
            }

        .logout-btn {
            background-color: #ffebee;
            color: #e53935;
        }

            .logout-btn:active {
                background-color: #fce4ec;
            }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
        }

        .menu-item {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            text-decoration: none;
            color: inherit;
            transition: transform 0.2s, box-shadow 0.2s;
        }

            .menu-item:active {
                transform: scale(0.98);
                box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
            }

        .menu-icon {
            font-size: 30px;
            margin-bottom: 10px;
            color: #1AAD19;
        }

        .menu-text {
            font-size: 16px;
        }

        /* 设备控制按钮样式 */
        .device-controls {
            padding: 15px;
            background-color: #fff;
            margin: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .device-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
            padding-left: 5px;
            border-left: 3px solid #1AAD19;
        }

        .device-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .device-btn {
            padding: 12px 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 15px;
            background-color: #f5f5f5;
            color: #333;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

            .device-btn:active {
                background-color: #e0e0e0;
            }

            .device-btn.success {
                background-color: #e8f5e9;
                color: #1AAD19;
            }

            .device-btn.danger {
                background-color: #ffebee;
                color: #e53935;
            }

        .weui-tabbar {
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        body {
            padding-bottom: 50px;
            background-color: #f5f5f5;
        }

        /* 牌局列表项样式 */
        .game-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

            .game-item:last-child {
                border-bottom: none;
            }

        .game-status {
            display: inline-block;
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 4px;
            background-color: #fff8e6;
            color: #ff9800;
            margin-left: 5px;
        }

        .join-disabled {
            color: #999;
            cursor: not-allowed;
        }

            .join-disabled .weui-cell__ft {
                display: none;
            }

        /* 加载提示样式 */
        .loading-toast {
            display: none;
        }
    </style>
</head>

<body>
    <div class="user-info">
        <div class="user-main">
            <img src="@(!string.IsNullOrEmpty(Model.User.AvatarUrl)
                 ? Model.User.AvatarUrl
                : $"https://picsum.photos/60/60?random={Model.User.Id}")"
                 alt="@Model.User.Nickname 的头像" class="user-avatar">
            <div>
                <div class="user-nickname">你好，@Model.User.Nickname！</div>
                @* <div class="user-stats"> *@
                @*     累计牌局: @Model.User.TotalGames 局 | 总战绩: ¥@Model.User.TotalNetResult *@
                @* </div> *@
            </div>
        </div>

        <!-- 新增的操作按钮 -->
        <div class="user-actions">
            <a href="@Url.Action("CreateOrUpdate", "User", new { userId = Model.User.Id })" class="user-action-btn edit-profile">
                <i class="fa fa-pencil mr-1"></i>修改资料
            </a>
            <a href="javascript:;" class="user-action-btn logout-btn" id="headerLogoutBtn">
                <i class="fa fa-sign-out mr-1"></i>退出
            </a>
        </div>
    </div>

    <div class="menu-grid">
        <a href="@Url.Action("Create", "Game")" class="menu-item">
            <div class="menu-icon"><i class="fa fa-plus-circle"></i></div>
            <div class="menu-text">创建牌局</div>
        </a>
        <a href="#" class="menu-item" id="joinGame">
            <div class="menu-icon"><i class="fa fa-users"></i></div>
            <div class="menu-text">加入牌局</div>
        </a>
        <a href="@Url.Action("History", "Home")" class="menu-item">
            <div class="menu-icon"><i class="fa fa-history"></i></div>
            <div class="menu-text">历史记录</div>
        </a>
        <a href="@Url.Action("Rankings", "Home")" class="menu-item">
            <div class="menu-icon"><i class="fa fa-trophy"></i></div>
            <div class="menu-text">排行榜单</div>
        </a>
    </div>

    <!-- 设备控制区域 -->
    <div class="device-controls">
        <div class="device-title">设备控制</div>
        <div class="device-buttons">
            @* <button class="device-btn success" onclick="controlDevice('trun_on_entrance_guard')"> *@
            @*     <i class="fa fa-unlock-alt"></i>开门禁 *@
            @* </button> *@
            @* <button class="device-btn success" onclick="controlDevice('open_door')"> *@
            @*     <i class="fa fa-door-open"></i>开门 *@
            @* </button> *@
            <button class="device-btn success" onclick="controlDevice('turn_on_mahjong_machine')">
                <i class="fa fa-power-off"></i>开麻将机
            </button>
            <button class="device-btn danger" onclick="controlDevice('turn_off_mahjong_machine')">
                <i class="fa fa-power-off"></i>关麻将机
            </button>
        </div>
    </div>

    <div class="weui-tabbar">
        <a href="#" class="weui-tabbar__item weui-bar__item_on">
            <i class="weui-tabbar__icon fa fa-home"></i>
            <p class="weui-tabbar__label">首页</p>
        </a>
        <a href="@Url.Action("History", "Home")" class="weui-tabbar__item">
            <i class="weui-tabbar__icon fa fa-history"></i>
            <p class="weui-tabbar__label">历史</p>
        </a>
        <a href="@Url.Action("Rankings", "Home")" class="weui-tabbar__item">
            <i class="weui-tabbar__icon fa fa-trophy"></i>
            <p class="weui-tabbar__label">榜单</p>
        </a>
    </div>

    <script>
        // 设备控制API地址（请根据实际情况修改）
        const DEVICE_CONTROL_API = '@Url.Action("ControlDevice", "Home")';

        // 页面加载完成后初始化
        $(document).ready(function() {
            // 加入牌局功能
            $('#joinGame').on('click', function(e) {
                e.preventDefault();
                showOngoingGamesModal();
            });

            $('.logout-btn').on('click', function(e) {
                e.preventDefault();

                $.confirm({
                    title: '确认退出',
                    text: '确定要退出当前账号吗？',
                    onOK: function() {
                        window.location.href = "@Url.Action("Logout", "Home")";
                    }
                });
            });
        });

        // 设备控制函数
        function controlDevice(action) {
            // 显示加载提示
            $.showLoading('操作中...');

            // 发送请求控制设备
            const formData = new FormData();
            formData.append('action', action);
            formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

            fetch(DEVICE_CONTROL_API, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // 检查HTTP响应状态
                if (!response.ok) {
                    throw new Error(`HTTP错误，状态码: ${response.status}`);
                }
                // 解析JSON响应
                return response.json();
            })
            .then(data => {
                $.hideLoading();
                if (data.success) {
                    $.toast('操作成功', 'success');
                } else {
                    $.toast(data.message || '操作失败', 'cancel');
                }
            })
            .catch(error => {
                $.hideLoading();
                $.toast('网络错误，请重试', 'forbidden');
                console.error('设备控制失败:', error);
            });
        }

        // 显示进行中的牌局模态框
        function showOngoingGamesModal() {
            // 使用jQuery WeUI的actionsheet组件
            $.actions({
                title: "选择进行中的牌局",
                onClose: function() {
                    console.log("弹窗已关闭");
                },
                actions: [{
                    // 这里只是占位，实际内容将通过AJAX加载
                    text: '<i class="fa fa-spinner fa-spin"></i> 加载中...',
                    className: 'loading-placeholder'
                }]
            });

            // 请求进行中的牌局数据
            $.get('@Url.Action("OngoingGames", "Home")')
                .done(function(games) {
                    // 关闭初始的加载占位弹窗
                    $('.weui-mask').trigger('click');

                    if (!games || games.length === 0) {
                        // 显示无牌局提示
                        $.actions({
                            title: "选择进行中的牌局",
                            actions: [{
                                text: `
                                    <div style="padding: 40px 20px; text-align: center; color: #888;">
                                        <i class="fa fa-calendar-o" style="font-size: 48px; margin-bottom: 15px;"></i>
                                        <p>暂无进行中的牌局</p>
                                        <p style="font-size: 14px; margin-top: 5px;">请创建新的牌局开始游戏</p>
                                    </div>
                                `,
                                className: 'no-games',
                                onClick: function() {
                                    // 点击无反应
                                    return false;
                                }
                            }]
                        });
                        return;
                    }

                    // 构建牌局列表
                    const actions = games.map(game => {
                        // 格式化日期时间
                        const formattedTime = new Date(game.created_at).toLocaleString();
                        const joinClass = game.can_join ? '' : 'join-disabled';
                        const joinTip = game.can_join ? '' : `<span class="game-status">已加入</span>`;

                        return {
                            text: `
                                <div class="weui-cell__bd">
                                    <div style="font-weight: 500;">
                                        牌局 #${game.id} ${joinTip}
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-top: 4px;">
                                        创建者: ${game.creator_name} | 参与: ${game.player_count}人
                                    </div>
                                    <div style="font-size: 12px; color: #999; margin-top: 2px;">
                                        创建时间: ${formattedTime}
                                    </div>
                                </div>
                            `,
                            className: `game-item ${joinClass}`,
                            onClick: function() {
                                window.location.href = '@Url.Action("Join", "Game")?gameId=' + game.id;
                                return false; // 阻止自动关闭，手动控制
                            }
                        };
                    });


                    // 显示牌局列表弹窗
                    $.actions({
                        title: "选择进行中的牌局",
                        actions: actions
                    });
                })
                .fail(function(error) {
                    console.error('获取牌局失败:', error);
                    // 关闭初始弹窗
                    $('.weui-mask').trigger('click');

                    // 显示错误提示
                    $.actions({
                        title: "加载失败",
                        actions: [{
                            text: `
                                <div style="padding: 40px 20px; text-align: center; color: #e64340;">
                                    <i class="fa fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                                    <p>数据加载失败</p>
                                    <button class="weui-btn weui-btn_mini weui-btn_default" onclick="showOngoingGamesModal()">
                                        重试
                                    </button>
                                </div>
                            `,
                            className: 'error-state',
                            onClick: function() {
                                return false;
                            }
                        }]
                    });
                });
        }
    </script>

    <!-- 添加防伪令牌用于POST请求 -->
    @Html.AntiForgeryToken()
</body>

</html>
